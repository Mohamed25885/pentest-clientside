from PyQt5.QtCore import QThread, pyqtSignal
from Service import BaseService
from PyQt5.QtWidgets import QPushButton, QTextEdit
from requests import Response
from pyqtspinner import WaitingSpinner
from PyQt5.QtCore import QRunnable, QThread, QMetaObject, Q_ARG, Qt, QProcess
from PyQt5.QtCore import pyqtSlot, QThreadPool, QObject
import requests
import json

class bruteForceService(BaseService):
    def __init__(self, main, button: QPushButton, output: QTextEdit):
        super().__init__(main)
        self.button = button
        self.output = output

    def before_request(self):
        self.button.setDisabled(True)

    def onResponse(self, **kwargs):
        res: Response = kwargs['response']
        self.button.setDisabled(False)
        data = res.json()['data']
        if isinstance(data, dict) and 'messages' in data:
                formatted_data = json.dumps(data, indent=4)
                messages = data['messages']
                formatted_data = "\n".join([f"\"{key}\":  {value}" for key, value in messages.items()])
                self.output.setText(formatted_data)
        else:
                self.output.setText(str(data))
        # self.output.setText(data)
        

    def bruteForce(self, jwtstring,keylist,algo):

        url = "/jwt/brute-force"
        json_data = {"jwt_string":jwtstring,"keylist":keylist,"algo":algo}
        response = self.request("post", url, json=json_data)
        print(response)
        self.before_request()
        self.spinner.start()



