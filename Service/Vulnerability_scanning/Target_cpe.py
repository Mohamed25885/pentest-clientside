from Service import BaseService
from PyQt5.QtWidgets import QPushButton, QLineEdit,QTextEdit
from PyQt5.QtCore import QObject
from requests import Response
from urllib.parse import urlparse

class TargetCpeService(BaseService):
    def __init__(self, main: QObject, button: QPushButton, output: QTextEdit) -> None:
        super().__init__(main)
        self.button = button
        self.output = output

    def before_request(self):
        self.button.setDisabled(True)

    def onError(self):
        self.button.setDisabled(False)

    def onResponse(self, **kwargs):
        res: Response = kwargs['response']
        self.button.setDisabled(False)
        data = res.json()['data']
        formatted_data = ""

        if isinstance(data, dict):
            formatted_data = ""
            for key, value in data.items():
                if value:
                    formatted_data += f'"{key}":\n'
                    formatted_data += ",\n".join(str(item) for item in value)
                    formatted_data += "\n\n"
                else:
                    formatted_data += f'"{key}": (empty)\n'
        else:
            formatted_data = str(data)

        self.output.setText(formatted_data)




    def Target_cpe(self, url: str):
        self.request("get", "/vulnerabilities/target-cpe",
                         params={"url": url})
